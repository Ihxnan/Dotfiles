#!/usr/bin/env bash
#
# sources_config=(
#     .config/alacritty/
#     .config/fish/
#     .config/i3blocks/
#     .config/nvim/
#     .config/ranger/
#     .config/picom.conf
#     ~/.config/mpd/
#     ~/.config/ncmpcpp
#     ~/.config/dunst/
# )
#
# sources_home=(
#     .vimrc
#     .i3/
#     .zshrc
#     .p10k.zsh
# )
#
# target_config=(
#     ~/.config/alacritty/
#     ~/.config/fish/
#     ~/.config/i3blocks/
#     ~/.config/nvim/
#     ~/.config/ranger/
#     ~/.config/picom.conf
#     ~/.config/mpd/
#     ~/.config/ncmpcpp
#     ~/.config/dunst/
# )
#
# target_home=(
#     ~/.vimrc
#     ~/.i3/
#     ~/.zshrc
#     ~/.p10k.zsh
# )
#
# rm -rf "${target_config[@]}"
# rm -rf "${target_home[@]}"
#
# cp -r "${sources_config[@]}" ~/.config/
# cp -r "${sources_home[@]}" ~/
#

#!/usr/bin/env bash
set -euo pipefail  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºï¼Œé¿å…é…ç½®æ··ä¹±

# ========================= 1. é…ç½®è·¯å¾„å®šä¹‰ =========================
# æ³¨æ„ï¼š
# - sources_* æ•°ç»„ï¼šæºé…ç½®æ–‡ä»¶/ç›®å½•çš„ã€ç›¸å¯¹è·¯å¾„ã€‘ï¼ˆå‡è®¾è„šæœ¬ä¸è¿™äº›é…ç½®åœ¨åŒä¸€ç›®å½•ï¼‰
# - targets_* æ•°ç»„ï¼šç›®æ ‡è·¯å¾„ï¼ˆå³é…ç½®æœ€ç»ˆè¦ç”Ÿæ•ˆçš„è·¯å¾„ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„ ~ï¼‰
# - ç¡®ä¿ sources ä¸ targets æ•°ç»„çš„ã€é¡ºåºå®Œå…¨å¯¹åº”ã€‘

# 1.1 å¯¹åº” ~/.config/ ä¸‹çš„é…ç½®ï¼ˆç›®å½•/æ–‡ä»¶ï¼‰
sources_config=(
    ".config/alacritty"
    ".config/fish"
    ".config/i3blocks"
    ".config/nvim"
    ".config/ranger"
    ".config/picom.conf"
    ".config/mpd"
    ".config/ncmpcpp"
    ".config/dunst"
)
targets_config=(
    "$HOME/.config/alacritty"
    "$HOME/.config/fish"
    "$HOME/.config/i3blocks"
    "$HOME/.config/nvim"
    "$HOME/.config/ranger"
    "$HOME/.config/picom.conf"
    "$HOME/.config/mpd"
    "$HOME/.config/ncmpcpp"
    "$HOME/.config/dunst"
)

# 1.2 å¯¹åº” ~/ æ ¹ç›®å½•ä¸‹çš„é…ç½®ï¼ˆæ–‡ä»¶/ç›®å½•ï¼‰
sources_home=(
    ".vimrc"
    ".i3"
    ".zshrc"
    ".p10k.zsh"
)
targets_home=(
    "$HOME/.vimrc"
    "$HOME/.i3"
    "$HOME/.zshrc"
    "$HOME/.p10k.zsh"
)

# ========================= 2. å·¥å…·å‡½æ•°ï¼ˆå¤ç”¨é€»è¾‘ï¼‰ =========================
# å‡½æ•°ï¼šåˆ›å»ºè½¯é“¾æ¥ï¼ˆå‚æ•°1ï¼šæºè·¯å¾„ï¼Œå‚æ•°2ï¼šç›®æ ‡è·¯å¾„ï¼‰
create_symlink() {
    local src="$1"
    local dest="$2"
    local src_abs  # æºè·¯å¾„çš„ç»å¯¹è·¯å¾„
    local dest_dir # ç›®æ ‡è·¯å¾„çš„çˆ¶ç›®å½•

    # 2.1 æ ¡éªŒæºè·¯å¾„æ˜¯å¦å­˜åœ¨
    if [ ! -e "$src" ]; then
        echo -e "âš ï¸  æºè·¯å¾„ä¸å­˜åœ¨ï¼Œè·³è¿‡ï¼š$src"
        return 1
    fi

    # 2.2 è·å–æºè·¯å¾„çš„ç»å¯¹è·¯å¾„ï¼ˆé¿å…ç›¸å¯¹è·¯å¾„è½¯é“¾æ¥å¤±æ•ˆï¼‰
    src_abs=$(realpath "$src")

    # 2.3 ç¡®ä¿ç›®æ ‡è·¯å¾„çš„çˆ¶ç›®å½•å­˜åœ¨ï¼ˆå¦‚ ~/.config/ å·²å­˜åœ¨ï¼Œä½†å­ç›®å½•å¯èƒ½è¢«åˆ é™¤ï¼‰
    dest_dir=$(dirname "$dest")
    if [ ! -d "$dest_dir" ]; then
        echo -e "ğŸ“‚ åˆ›å»ºç›®æ ‡çˆ¶ç›®å½•ï¼š$dest_dir"
        mkdir -p "$dest_dir"
    fi

    # 2.4 å¤„ç†å·²å­˜åœ¨çš„ç›®æ ‡è·¯å¾„ï¼ˆåˆ é™¤æ—§æ–‡ä»¶/è½¯é“¾æ¥ï¼‰
    if [ -e "$dest" ] || [ -L "$dest" ]; then
        # åŒºåˆ†â€œè½¯é“¾æ¥â€å’Œâ€œå®é™…æ–‡ä»¶/ç›®å½•â€ï¼Œç»™å‡ºä¸åŒæç¤º
        if [ -L "$dest" ]; then
            echo -e "ğŸ”— åˆ é™¤æ—§è½¯é“¾æ¥ï¼š$dest"
        else
            echo -e "ğŸ—‘ï¸  åˆ é™¤æ—§æ–‡ä»¶/ç›®å½•ï¼š$dest"
        fi
        rm -rf "$dest"
    fi

    # 2.5 åˆ›å»ºè½¯é“¾æ¥
    ln -s "$src_abs" "$dest"
    echo -e "âœ… å·²åˆ›å»ºè½¯é“¾æ¥ï¼š\n  æºï¼š$src_abs\n  ç›®æ ‡ï¼š$dest"
}

# ========================= 3. æ‰§è¡Œè½¯é“¾æ¥åˆ›å»º =========================
echo -e "=== å¼€å§‹é…ç½® .config/ ç›®å½•ä¸‹çš„è½¯é“¾æ¥ ==="
# éå† sources_config ä¸ targets_configï¼ˆé€šè¿‡ç´¢å¼•å¯¹åº”ï¼‰
for i in "${!sources_config[@]}"; do
    src="${sources_config[$i]}"
    dest="${targets_config[$i]}"
    create_symlink "$src" "$dest"
    echo -e "------------------------"
done

echo -e "\n=== å¼€å§‹é…ç½® ~/ æ ¹ç›®å½•ä¸‹çš„è½¯é“¾æ¥ ==="
# éå† sources_home ä¸ targets_home
for i in "${!sources_home[@]}"; do
    src="${sources_home[$i]}"
    dest="${targets_home[$i]}"
    create_symlink "$src" "$dest"
    echo -e "------------------------"
done

# ========================= 4. é…ç½®å®Œæˆæç¤º =========================
echo -e "\nğŸ‰ æ‰€æœ‰è½¯é“¾æ¥é…ç½®å®Œæˆï¼"
echo -e "æç¤ºï¼š\n  1. ä¿®æ”¹æºé…ç½®æ–‡ä»¶åï¼Œç›®æ ‡è·¯å¾„ä¼šè‡ªåŠ¨åŒæ­¥ï¼ˆæ— éœ€é‡æ–°è¿è¡Œè„šæœ¬ï¼‰\n  2. è‹¥éœ€åˆ é™¤é…ç½®ï¼Œç›´æ¥åˆ é™¤ç›®æ ‡è·¯å¾„çš„è½¯é“¾æ¥å³å¯ï¼ˆæºæ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤ï¼‰"
