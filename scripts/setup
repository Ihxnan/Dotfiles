#!/usr/bin/env bash
set -euo pipefail  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºï¼Œé¿å…é…ç½®æ··ä¹±

# ========================= 1. é…ç½®è·¯å¾„å®šä¹‰ï¼ˆä¿æŒæ ¸å¿ƒé€»è¾‘ï¼Œè¡¥å……æ³¨é‡Šï¼‰ =========================
# å‰æï¼šè„šæœ¬ä¸æºé…ç½®åœ¨åŒä¸€ç›®å½•ï¼ˆå¦‚ ~/Github/Dotfiles/ï¼‰
# è§„åˆ™ï¼šsources_* ç›¸å¯¹è·¯å¾„ï¼Œtargets_* ç»å¯¹è·¯å¾„ï¼ˆç›®å½•æ—  /ï¼‰ï¼Œæ•°ç»„é¡ºåºä¸€ä¸€å¯¹åº”

# 1.1 ~/.config/ ä¸‹çš„é…ç½®ï¼ˆRanger æ‹†åˆ†ä¸ºæ ¸å¿ƒæ–‡ä»¶ï¼Œæ’é™¤ __pycache__ï¼‰
sources_config=(
    ".config/alacritty"
    ".config/fish"
    ".config/i3blocks"
    ".config/nvim"                # Neovim é…ç½®ï¼ˆè‹¥é‡è½¯é“¾æ¥å¾ªç¯ï¼Œéœ€æ‹†åˆ†ä¸ºå­ç›®å½•/æ–‡ä»¶ï¼‰
    ".config/ranger/rc.conf"
    ".config/ranger/commands.py"
    ".config/ranger/devicons.py"  # Ranger å›¾æ ‡è„šæœ¬ï¼ˆéœ€ç¡®ä¿æƒé™ï¼‰
    ".config/ranger/plugins"
    ".config/ranger/scope.sh"
    ".config/picom.conf"
    ".config/mpd"
    ".config/ncmpcpp"
    ".config/dunst"
    ".config/polybar"
)
targets_config=(
    "$HOME/.config/alacritty"
    "$HOME/.config/fish"
    "$HOME/.config/i3blocks"
    "$HOME/.config/nvim"
    "$HOME/.config/ranger/rc.conf"
    "$HOME/.config/ranger/commands.py"
    "$HOME/.config/ranger/devicons.py"
    "$HOME/.config/ranger/plugins"
    "$HOME/.config/ranger/scope.sh"
    "$HOME/.config/picom.conf"
    "$HOME/.config/mpd"
    "$HOME/.config/ncmpcpp"
    "$HOME/.config/dunst"
    "$HOME/.config/polybar"
)

# 1.2 ~/ æ ¹ç›®å½•ä¸‹çš„é…ç½®ï¼ˆå« Zsh custom ç›®å½•ï¼‰
sources_home=(
    ".vimrc"
    ".i3"
    ".zshrc"
    ".p10k.zsh"
    "custom"  # Zsh æ’ä»¶/ä¸»é¢˜ç›®å½•
    ".Xresources"
    ".profile"
    ".scripts"
)
targets_home=(
    "$HOME/.vimrc"
    "$HOME/.i3"
    "$HOME/.zshrc"
    "$HOME/.p10k.zsh"
    "$HOME/.oh-my-zsh/custom"
    "$HOME/.Xresources"
    "$HOME/.profile"
    "$HOME/.scripts"
)

# ========================= 2. å·¥å…·å‡½æ•° =========================
# å‡½æ•°1ï¼šåˆ›å»ºè½¯é“¾æ¥ + è‡ªåŠ¨ä¿®å¤è„šæœ¬æƒé™
create_symlink() {
    local src="$1"
    local dest="$2"
    local src_abs
    local dest_dir

    # 2.1 æ ¡éªŒæºè·¯å¾„
    if [ ! -e "$src" ]; then
        echo -e "âš ï¸  æºè·¯å¾„ä¸å­˜åœ¨ï¼Œè·³è¿‡ï¼š$src"
        return 1
    fi
    src_abs=$(realpath "$src")

    # 2.2 ç¡®ä¿ç›®æ ‡çˆ¶ç›®å½•å­˜åœ¨
    dest_dir=$(dirname "$dest")
    if [ ! -d "$dest_dir" ]; then
        echo -e "ğŸ“‚ åˆ›å»ºç›®æ ‡çˆ¶ç›®å½•ï¼š$dest_dir"
        mkdir -p "$dest_dir"
    fi

    # 2.3 å¤„ç†æ—§ç›®æ ‡
    if [ -e "$dest" ] || [ -L "$dest" ]; then
        [ -L "$dest" ] && echo -e "ğŸ”— åˆ é™¤æ—§è½¯é“¾æ¥ï¼š$dest" || echo -e "ğŸ—‘ï¸  åˆ é™¤æ—§æ–‡ä»¶/ç›®å½•ï¼š$dest"
        rm -rf "$dest"
    fi

    # 2.4 åˆ›å»ºè½¯é“¾æ¥
    ln -s "$src_abs" "$dest"
    echo -e "âœ… è½¯é“¾æ¥åˆ›å»ºæˆåŠŸï¼š\n  æºï¼š$src_abs\n  ç›®æ ‡ï¼š$dest"

    # å¯¹ .py/.sh ç­‰å¯æ‰§è¡Œè„šæœ¬ï¼Œè‡ªåŠ¨æ·»åŠ ã€Œæ‰€æœ‰è€…è¯»+æ‰§è¡Œæƒé™ã€
    if [[ "$src_abs" =~ \.(py|sh)$ ]]; then
        # å…ˆæ£€æŸ¥å½“å‰æƒé™ï¼Œæ— æ‰§è¡Œæƒé™æ—¶æ‰ä¿®æ”¹
        if [ ! -x "$src_abs" ]; then
            chmod u+rx "$src_abs"
            echo -e "ğŸ”§ è‡ªåŠ¨ä¿®å¤è„šæœ¬æƒé™ï¼š$src_absï¼ˆæ·»åŠ  u+rx æƒé™ï¼‰"
        fi
    fi
}

# å‡½æ•°2ï¼šæ ¡éªŒ Oh My Zsh å®‰è£…
check_oh_my_zsh() {
    local omz_dir="$HOME/.oh-my-zsh"
    if [ ! -d "$omz_dir" ]; then
        echo -e "\nâš ï¸  Oh My Zsh æœªå®‰è£…ï¼ˆ$omz_dir ä¸å­˜åœ¨ï¼‰"
        read -p "æ˜¯å¦ç«‹å³å®‰è£…ï¼Ÿ(y/nï¼Œé»˜è®¤ n)ï¼š" install_choice
        install_choice=${install_choice:-n}

        if [ "$install_choice" = "y" ]; then
            echo -e "ğŸ”§ å®‰è£… Oh My Zsh..."
            sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
            echo -e "âœ… Oh My Zsh å®‰è£…å®Œæˆ"
        else
            echo -e "â„¹ï¸  è·³è¿‡ custom ç›®å½•é…ç½®"
            sources_home=("${sources_home[@]::${#sources_home[@]}-1}")
            targets_home=("${targets_home[@]::${#targets_home[@]}-1}")
        fi
    fi
}

# å‡½æ•°3ï¼šæ£€æµ‹ Neovim è½¯é“¾æ¥å¾ªç¯é£é™©
check_nvim_symlink_cycle() {
    local nvim_src="${sources_config[3]}"  # sources_config ä¸­ç¬¬4ä¸ªå…ƒç´ æ˜¯ .config/nvim
    local nvim_dest="${targets_config[3]}" # targets_config ä¸­ç¬¬4ä¸ªå…ƒç´ æ˜¯ ~/.config/nvim

    # è‹¥ Neovim æ˜¯ç›®å½•çº§è½¯é“¾æ¥ï¼Œæç¤ºå¾ªç¯é£é™©ï¼ˆé’ˆå¯¹ VimWiki åœºæ™¯ï¼‰
    if [ -d "$nvim_src" ] && [ "$(basename "$nvim_src")" = "nvim" ]; then
        echo -e "\nâš ï¸  æ£€æµ‹åˆ° Neovim æ˜¯ç›®å½•çº§è½¯é“¾æ¥ï¼Œå¯èƒ½å¯¼è‡´ VimWiki å¾ªç¯é”™è¯¯ï¼"
        echo -e "   è§£å†³æ–¹æ¡ˆï¼šå°† Neovim æ‹†åˆ†ä¸ºå­ç›®å½•/æ–‡ä»¶çº§è½¯é“¾æ¥ï¼Œå‚è€ƒå‘½ä»¤ï¼š"
        echo -e "   1. rm $nvim_dest"
        echo -e "   2. mkdir -p $nvim_dest"
        echo -e "   3. ln -s ~/Github/Dotfiles/.config/nvim/init.lua $nvim_dest/init.lua"
        echo -e "   4. ln -s ~/Github/Dotfiles/.config/nvim/lua $nvim_dest/lua"
        read -p "æ˜¯å¦ç»§ç»­å½“å‰é…ç½®ï¼Ÿ(y/nï¼Œé»˜è®¤ y)ï¼š" continue_choice
        continue_choice=${continue_choice:-y}
        if [ "$continue_choice" = "n" ]; then
            echo -e "âŒ é€€å‡ºè„šæœ¬ï¼Œè¯·å…ˆè°ƒæ•´ Neovim é…ç½®æ–¹å¼"
            exit 1
        fi
    fi
}

# ========================= 3. ä¸»æ‰§è¡Œæµç¨‹ =========================
# æ­¥éª¤1ï¼šæ ¡éªŒ Oh My Zsh
echo -e "=== ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒ Oh My Zsh ç¯å¢ƒ ==="
if [[ " ${sources_home[@]} " =~ " custom " ]]; then
    check_oh_my_zsh
fi

# æ­¥éª¤2ï¼šæ£€æµ‹ Neovim è½¯é“¾æ¥å¾ªç¯é£é™©ï¼ˆæ–°å¢ï¼‰
echo -e "\n=== ç¬¬äºŒæ­¥ï¼šæ£€æµ‹ Neovim è½¯é“¾æ¥å¾ªç¯é£é™© ==="
check_nvim_symlink_cycle

# æ­¥éª¤3ï¼šé…ç½® ~/.config/ è½¯é“¾æ¥
echo -e "\n=== ç¬¬ä¸‰æ­¥ï¼šé…ç½® ~/.config/ ç›®å½•è½¯é“¾æ¥ ==="
for i in "${!sources_config[@]}"; do
    create_symlink "${sources_config[$i]}" "${targets_config[$i]}"
    echo -e "------------------------"
done

# æ­¥éª¤4ï¼šé…ç½® ~/ æ ¹ç›®å½•è½¯é“¾æ¥
echo -e "\n=== ç¬¬å››æ­¥ï¼šé…ç½® ~/ æ ¹ç›®å½•è½¯é“¾æ¥ ==="
for i in "${!sources_home[@]}"; do
    create_symlink "${sources_home[$i]}" "${targets_home[$i]}"
    echo -e "------------------------"
done

# ========================= 4. é…ç½®å®Œæˆæç¤º =========================
echo -e "\nğŸ‰ æ‰€æœ‰è½¯é“¾æ¥é…ç½®å®Œæˆï¼"
echo -e "\nğŸ“Œ ç”Ÿæ•ˆæŒ‡å—ï¼š"
echo -e "  - ç»ˆç«¯åº”ç”¨ï¼šé‡å¯ç»ˆç«¯ï¼›i3ï¼šMod + Shift + Rï¼›Picom/Dunstï¼špkill è¿›ç¨‹åé‡å¯ï¼›"
echo -e "  - ä¿®æ”¹é…ç½®ï¼šç›´æ¥ç¼–è¾‘ ~/Github/Dotfiles/ ä¸‹çš„æºæ–‡ä»¶ï¼Œç›®æ ‡è·¯å¾„è‡ªåŠ¨åŒæ­¥ã€‚"
